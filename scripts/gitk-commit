#!/bin/bash

set -e -o pipefail

flags=()
detailed=false
confirm=true

for arg in "$@"; do
    case "$arg" in
        --detailed) detailed=true ;;
        --yes|--no-confirm) confirm=false ;;
        --*) flags+=("$arg") ;;
    esac
done


if git diff --cached --quiet; then
    echo "Индекс пуст. Нечего коммитить."
    exit 0
else
    echo "Есть изменения в индексе. Генерируем коммит."

    diff=$(git diff --cached)

    if [[ "$detailed" == "true" ]]; then
        commit_message=$(echo "$diff" | python3 "$(dirname "$0")/../generator.py" --detailed)
    else
        commit_message=$(echo "$diff" | python3 "$(dirname "$0")/../generator.py")
    fi

    tmpfile=$(mktemp)
    trap 'rm -f "$tmpfile"' EXIT
    
    echo "$commit_message" > "$tmpfile"
    echo -e "Коммит:\n----------------------\n$commit_message\n----------------------"

    if [[ "$confirm" == "true" ]]; then
        read -p "Хотите продолжить? (y/n): " answer
        if [[ "$answer" =~ ^[yY]$ ]]; then
            git commit "${flags[@]}" -F "$tmpfile"
        else
            echo "Отменено."
        fi 
    else 
        git commit "${flags[@]}" -F "$tmpfile"
    fi
fi
